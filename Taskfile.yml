version: "3"

vars:
  VERSION: '{{.VERSION | default "dev"}}'
  BUILD_TIME:
    sh: date -u '+%Y-%m-%d %H:%M:%S UTC'
  COVERAGE_THRESHOLD: 50

tasks:
  # === é€šç”¨å·¥å…· ===
  setup-docker-compose:
    desc: è®¾ç½® Docker Compose å‘½ä»¤åˆ«å
    internal: true
    cmds:
      - |
        if command -v docker-compose >/dev/null 2>&1; then
          echo "âœ… ä½¿ç”¨å·²å®‰è£…çš„ docker-compose å‘½ä»¤"
          export DOCKER_COMPOSE_CMD="docker-compose"
        elif docker compose version >/dev/null 2>&1; then
          echo "âœ… ä½¿ç”¨ Docker Compose v2 (docker compose)"
          export DOCKER_COMPOSE_CMD="docker compose"
        else
          echo "âŒ æœªæ‰¾åˆ° Docker Composeï¼Œè¯·å®‰è£… Docker Compose"
          exit 1
        fi

  # === ä¾èµ–ç®¡ç† ===
  deps:
    desc: ä¸‹è½½ä¾èµ–
    cmds:
      - go mod download

  tidy:
    desc: æ•´ç†ä¾èµ–
    cmds:
      - go mod tidy

  deps-check:
    desc: æ£€æŸ¥ä¾èµ–æ˜¯å¦éœ€è¦æ›´æ–°
    silent: true
    cmds:
      - go mod tidy
      - |
        if ! git diff --exit-code go.mod go.sum >/dev/null 2>&1; then
          echo "âŒ go.mod æˆ– go.sum æ–‡ä»¶éœ€è¦æ›´æ–°"
          echo "è¯·è¿è¡Œ: task tidy"
          exit 1
        else
          echo "âœ… ä¾èµ–æ–‡ä»¶æ˜¯æœ€æ–°çš„"
        fi

  # === ä»£ç è´¨é‡æ£€æŸ¥ ===
  vet:
    desc: è¿è¡Œ Go vet é™æ€åˆ†æ
    cmds:
      - go vet ./...

  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - go fmt ./...

  fmt-check:
    desc: æ£€æŸ¥ä»£ç æ ¼å¼
    silent: true
    cmds:
      - |
        unformatted=$(gofmt -l .)
        if [ -n "$unformatted" ]; then
          echo "âŒ ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
          echo "$unformatted"
          echo "è¯·è¿è¡Œ: task fmt"
          exit 1
        else
          echo "âœ… ä»£ç æ ¼å¼æ­£ç¡®"
        fi

  # === æµ‹è¯•ç›¸å…³ ===
  test:
    desc: è¿è¡Œå•å…ƒæµ‹è¯•
    cmds:
      - go test -v ./...

  test-race:
    desc: è¿è¡Œå•å…ƒæµ‹è¯• (å¸¦ç«æ€æ£€æµ‹)
    cmds:
      - go test -v -race ./...

  test-coverage:
    desc: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼ˆæ”¯æŒ Docker ç¯å¢ƒï¼‰
    cmds:
      - |
        # å¦‚æœè®¾ç½®äº† USE_DOCKER=trueï¼Œåˆ™å¯åŠ¨ Docker Compose ç¯å¢ƒ
        if [ "$USE_DOCKER" = "true" ]; then
          echo "ğŸ³ å¯åŠ¨ Docker Compose ç¯å¢ƒç”¨äºå•å…ƒæµ‹è¯•..."
          DOCKER_COMPOSE_CMD="docker-compose"
          if ! command -v docker-compose >/dev/null 2>&1; then
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            fi
          fi

          # å¯åŠ¨æµ‹è¯•ç¯å¢ƒï¼ˆä½¿ç”¨ 1x-2x é…ç½®ï¼ŒåŒ…å« 1.x å’Œ 2.x/3.x å…¼å®¹ï¼‰
          $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-2x.yml up -d
          echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
          sleep 10

          # è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨é›†æˆæµ‹è¯•
          export SKIP_INTEGRATION=false
          CLEANUP_DOCKER=true
        else
          echo "â„¹ï¸  è·³è¿‡ Docker ç¯å¢ƒï¼ˆè®¾ç½® USE_DOCKER=true å¯ç”¨ï¼‰"
          export SKIP_INTEGRATION=true
        fi

        # è¿è¡Œæµ‹è¯•
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        TEST_EXIT=$?

        # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        go tool cover -html=coverage.out -o coverage.html
        COVERAGE=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}' | sed 's/%//')
        echo ""
        echo "ğŸ“Š å½“å‰æµ‹è¯•è¦†ç›–ç‡: ${COVERAGE}%"

        # æ¸…ç† Docker ç¯å¢ƒ
        if [ "$CLEANUP_DOCKER" = "true" ]; then
          echo "ğŸ§¹ æ¸…ç† Docker ç¯å¢ƒ..."
          DOCKER_COMPOSE_CMD="docker-compose"
          if ! command -v docker-compose >/dev/null 2>&1; then
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            fi
          fi
          $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-2x.yml down
        fi

        # æ£€æŸ¥æµ‹è¯•ç»“æœ
        if [ $TEST_EXIT -ne 0 ]; then
          echo "âŒ æµ‹è¯•å¤±è´¥"
          exit 1
        fi

        # æ£€æŸ¥è¦†ç›–ç‡
        if (( $(echo "$COVERAGE < {{.COVERAGE_THRESHOLD}}" | bc -l) )); then
          echo "âŒ æµ‹è¯•è¦†ç›–ç‡ ${COVERAGE}% ä½äºè¦æ±‚çš„ {{.COVERAGE_THRESHOLD}}%"
          exit 1
        else
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡ ${COVERAGE}% è¾¾åˆ°è¦æ±‚"
        fi

  test-short:
    desc: è¿è¡Œå¿«é€Ÿæµ‹è¯• (è·³è¿‡é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•)
    cmds:
      - go test -v -short ./...

  # === æ„å»ºç›¸å…³ ===
  build:
    desc: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ (ä½¿ç”¨ GoReleaser)
    cmds:
      - goreleaser build --single-target --snapshot --clean

  build-with-version:
    desc: æ„å»ºå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„äºŒè¿›åˆ¶æ–‡ä»¶ (ä½¿ç”¨ GoReleaser)
    cmds:
      - goreleaser build --single-target --snapshot --clean

  build-release:
    desc: æ„å»ºå‘å¸ƒåŒ… (å¤šå¹³å°ï¼Œä½¿ç”¨ GoReleaser)
    cmds:
      - goreleaser build --snapshot --clean

  # === CI/CD ä»»åŠ¡ ===
  ci-quality:
    desc: CI ä»£ç è´¨é‡æ£€æŸ¥ (åŒ…å«æ‰€æœ‰æ£€æŸ¥é¡¹)
    deps: [deps]
    cmds:
      - task: deps-check
      - task: fmt-check
      - task: vet
      - task: test-coverage
      - task: build

  ci-integration:
    desc: CI é›†æˆæµ‹è¯• (æŒ‡å®šæ¨¡å¼)
    cmds:
      - |
        if [ -z "$SYNC_MODE" ]; then
          echo "âŒ è¯·è®¾ç½® SYNC_MODE ç¯å¢ƒå˜é‡ (1x-1x, 1x-2x, 2x-2x)"
          exit 1
        fi
        task test-$SYNC_MODE

  # === è¿è¡Œç›¸å…³ ===
  run:
    desc: è¿è¡Œä¸»ç¨‹åº
    cmds:
      - go run main.go

  run-with-config:
    desc: ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶è¿è¡Œ
    cmds:
      - |
        if [ -z "$CONFIG" ]; then
          echo "âŒ è¯·è®¾ç½® CONFIG ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶"
          exit 1
        fi
        go run main.go $CONFIG

  # === æ¸…ç†ç›¸å…³ ===
  clean:
    desc: æ¸…ç†æ„å»ºäº§ç‰©
    cmds:
      - rm -f influxdb-sync
      - rm -f coverage.out coverage.html
      - rm -f resume.state
      - rm -rf dist/

  clean-all:
    desc: æ¸…ç†æ‰€æœ‰äº§ç‰© (åŒ…æ‹¬ Docker)
    deps: [clean]
    cmds:
      - |
        DOCKER_COMPOSE_CMD="docker-compose"
        if ! command -v docker-compose >/dev/null 2>&1; then
          if docker compose version >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD="docker compose"
          fi
        fi
        $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-1x.yml down --volumes --remove-orphans || true
        $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-2x.yml down --volumes --remove-orphans || true
        $DOCKER_COMPOSE_CMD -f deployments/docker-compose-2x-2x.yml down --volumes --remove-orphans || true
        docker system prune -f || true

  # === å‘å¸ƒç›¸å…³ ===
  release:
    desc: å‘å¸ƒç‰ˆæœ¬ (éœ€è¦ Git æ ‡ç­¾)
    cmds:
      - goreleaser release --clean

  release-snapshot:
    desc: æ„å»ºå¿«ç…§ç‰ˆæœ¬ (æœ¬åœ°æµ‹è¯•ç”¨)
    cmds:
      - goreleaser release --snapshot --clean
      - echo "æ„å»ºäº§ç‰©åœ¨ dist/ ç›®å½•ä¸­"

  release-check:
    desc: æ£€æŸ¥ GoReleaser é…ç½®
    cmds:
      - goreleaser check

  # === é›†æˆæµ‹è¯• ===

  test-1x-1x:
    desc: ä¸€é”®æµ‹è¯• 1.x->1.x åŒæ­¥
    cmds:
      - |
        DOCKER_COMPOSE_CMD="docker-compose"
        if ! command -v docker-compose >/dev/null 2>&1; then
          if docker compose version >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD="docker compose"
          fi
        fi
        $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-1x.yml up -d
      - sleep 5
      - bash scripts/write_data_1x.sh
      - sleep 2
      - rm -f resume.state
      - go run main.go config.yaml
      - |
        ./scripts/verify_sync.sh -m 1x-1x
        if [ $? -ne 0 ]; then
          echo "æ•°æ®æ ¡éªŒå¤±è´¥ï¼Œè¯·äººå·¥æ’æŸ¥ï¼"
          exit 1
        else
          DOCKER_COMPOSE_CMD="docker-compose"
          if ! command -v docker-compose >/dev/null 2>&1; then
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            fi
          fi
          $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-1x.yml down
        fi

  test-1x-2x:
    desc: ä¸€é”®æµ‹è¯• 1.x->2.x åŒæ­¥
    cmds:
      - |
        DOCKER_COMPOSE_CMD="docker-compose"
        if ! command -v docker-compose >/dev/null 2>&1; then
          if docker compose version >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD="docker compose"
          fi
        fi
        $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-2x.yml up -d
      - sleep 8
      - bash scripts/write_data_1x.sh
      - sleep 2
      - docker exec influxdb2-dst influx bucket create --name testdb --token testtoken --org testorg || true
      - rm -f resume.state
      - go run main.go config_1x2x.yaml
      - |
        ./scripts/verify_sync.sh -m 1x-2x
        if [ $? -ne 0 ]; then
          echo "æ•°æ®æ ¡éªŒå¤±è´¥ï¼Œè¯·äººå·¥æ’æŸ¥ï¼"
          exit 1
        else
          DOCKER_COMPOSE_CMD="docker-compose"
          if ! command -v docker-compose >/dev/null 2>&1; then
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            fi
          fi
          $DOCKER_COMPOSE_CMD -f deployments/docker-compose-1x-2x.yml down
        fi

  test-2x-2x:
    desc: ä¸€é”®æµ‹è¯• 2.x->2.x åŒæ­¥
    cmds:
      - |
        DOCKER_COMPOSE_CMD="docker-compose"
        if ! command -v docker-compose >/dev/null 2>&1; then
          if docker compose version >/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD="docker compose"
          fi
        fi
        $DOCKER_COMPOSE_CMD -f deployments/docker-compose-2x-2x.yml up -d
      - sleep 8
      - bash scripts/write_data_2x.sh
      - sleep 2
      - rm -f resume.state
      - go run main.go config_2x2x.yaml
      - |
        ./scripts/verify_sync.sh -m 2x-2x
        if [ $? -ne 0 ]; then
          echo "æ•°æ®æ ¡éªŒå¤±è´¥ï¼Œè¯·äººå·¥æ’æŸ¥ï¼"
          exit 1
        else
          DOCKER_COMPOSE_CMD="docker-compose"
          if ! command -v docker-compose >/dev/null 2>&1; then
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            fi
          fi
          $DOCKER_COMPOSE_CMD -f deployments/docker-compose-2x-2x.yml down
        fi

  # === Git Hooks ç®¡ç† ===
  install-hooks:
    desc: å®‰è£… Git hooks (pre-commit)
    cmds:
      - |
        echo "ğŸ”§ å®‰è£… Git pre-commit hook..."
        if [ -f .git/hooks/pre-commit ]; then
          echo "âœ… pre-commit hook å·²å­˜åœ¨"
        else
          echo "âŒ pre-commit hook ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"
          exit 1
        fi
        chmod +x .git/hooks/pre-commit
        echo "âœ… Git hooks å®‰è£…å®Œæˆ"
        echo "ğŸ“ ç°åœ¨æ¯æ¬¡ git commit å‰ä¼šè‡ªåŠ¨ï¼š"
        echo "   - æ ¼å¼åŒ– Go ä»£ç  (task fmt)"
        echo "   - æ£€æŸ¥ä»£ç æ ¼å¼ (task fmt-check)"  
        echo "   - è¿è¡Œé™æ€åˆ†æ (task vet)"
        echo "   - æ£€æŸ¥ä¾èµ–çŠ¶æ€ (task deps-check)"

  uninstall-hooks:
    desc: å¸è½½ Git hooks
    cmds:
      - |
        echo "ğŸ—‘ï¸  å¸è½½ Git hooks..."
        if [ -f .git/hooks/pre-commit ]; then
          rm .git/hooks/pre-commit
          echo "âœ… pre-commit hook å·²åˆ é™¤"
        else
          echo "â„¹ï¸  pre-commit hook ä¸å­˜åœ¨"
        fi

  test-hooks:
    desc: æµ‹è¯• Git hooks åŠŸèƒ½
    cmds:
      - |
        echo "ğŸ§ª æµ‹è¯• pre-commit hook..."
        if [ -x .git/hooks/pre-commit ]; then
          echo "âœ… pre-commit hook å­˜åœ¨ä¸”å¯æ‰§è¡Œ"
          echo "ğŸ“‹ hook å†…å®¹é¢„è§ˆ:"
          head -10 .git/hooks/pre-commit
        else
          echo "âŒ pre-commit hook ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ"
          echo "è¯·è¿è¡Œ: task install-hooks"
        fi
